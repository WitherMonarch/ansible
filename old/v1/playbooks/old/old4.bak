- name: Install MariaDB Galera Cluster
  hosts: mariadb
  become: yes
  gather_facts: yes
  vars_files:
    - ../group_vars/mariadb.yml

  tasks:

    # 1️⃣ Install MariaDB Galera server
    - name: Install MariaDB Galera server
      dnf:
        name: mariadb-server-galera
        state: present

    # 2️⃣ Open firewall ports for MySQL and Galera
    - name: Open MariaDB and Galera ports in firewall
      firewalld:
        port: "{{ item }}"
        permanent: yes
        state: enabled
      loop:
        - 3306/tcp
        - 4567/tcp
        - 4568/tcp
        - 4444/tcp
      notify: reload firewalld

    - name: Set initial Galera bootstrap values for Maria1
      ini_file:
        path: /etc/my.cnf.d/galera.cnf
        section: mysqld
        option: "{{ item.option }}"
        value: "{{ item.value }}"
        backup: yes
      loop:
        - { option: "wsrep_on", value: "1" }
        - { option: "wsrep_cluster_name", value: "{{ galera_cluster_name }}" }
        - { option: "wsrep_cluster_address", value: "gcomm://" }
        - { option: "wsrep_node_address", value: "{{ ansible_host }}" }
        - { option: "wsrep_node_name", value: "maria1" }
        - { option: "wsrep_sst_auth", value: "root:{{ mariadb_root_password }}" }
      when: inventory_hostname == "maria1"

    # 4️⃣ Bootstrap Maria1
    - name: Bootstrap MariaDB cluster on maria1
      command: galera_new_cluster
      when: inventory_hostname == "maria1"

    # 5️⃣ Enable MariaDB service
    - name: Enable and start mariadb service
      systemd:
        name: mariadb
        enabled: yes
        state: started
      when: inventory_hostname == "maria1"

    - name: Update Maria1 galera.cnf after bootstrap to include all nodes
      ini_file:
        path: /etc/my.cnf.d/galera.cnf
        section: mysqld
        option: wsrep_cluster_address
        value: "gcomm://{{ galera_nodes | join(',') }}"
      when: inventory_hostname == "maria1"

    - name: Configure Galera join nodes
      ini_file:
        path: /etc/my.cnf.d/galera.cnf
        section: mysqld
        option: "{{ item.option }}"
        value: "{{ item.value }}"
        backup: yes
      loop:
        - { option: "wsrep_on", value: "1" }
        - { option: "wsrep_cluster_name", value: "{{ galera_cluster_name }}" }
        - { option: "wsrep_cluster_address", value: "gcomm://{{ galera_nodes | join(',') }}" }
        - { option: "wsrep_node_address", value: "{{ ansible_host }}" }
        - { option: "wsrep_node_name", value: "{{ inventory_hostname }}" }
        - { option: "wsrep_sst_auth", value: "root:{{ mariadb_root_password }}" }
      when: inventory_hostname != "maria1"

    # 8️⃣ Enable and start MariaDB on joining nodes
    - name: Enable and start mariadb on joining nodes
      systemd:
        name: mariadb
        enabled: yes
        state: started
      when: inventory_hostname != "maria1"

  handlers:
    - name: reload firewalld
      service:
        name: firewalld
        state: reloaded
