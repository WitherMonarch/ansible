- name: Install MariaDB Galera Cluster
  hosts: mariadb
  become: yes
  gather_facts: yes
  vars_files:
    - ../group_vars/mariadb.yml

  tasks:

    # 1️⃣ Install MariaDB Galera server
    - name: Install MariaDB Galera server
      dnf:
        name: mariadb-server-galera
        state: present

    # 2️⃣ Open firewall ports for MySQL and Galera
    - name: Open MariaDB and Galera ports in firewall
      firewalld:
        port: "{{ item }}"
        permanent: yes
        state: enabled
      loop:
        - 3306/tcp
        - 4567/tcp
        - 4568/tcp
        - 4444/tcp
      notify: reload firewalld

    # 3️⃣ Configure Maria1 bootstrap config
    - name: Copy Maria1 bootstrap galera.cnf
      template:
        src: ../templates/galera_maria1_bootstrap.cnf.j2
        dest: /etc/my.cnf.d/galera.cnf
        owner: root
        group: root
        mode: '0644'
      when: inventory_hostname == "maria1"

    # 4️⃣ Bootstrap Maria1
    - name: Bootstrap MariaDB cluster on Maria1
      command: galera_new_cluster
      when: inventory_hostname == "maria1"

    # 5️⃣ Enable Maria1 service
    - name: Enable and start Maria1
      systemd:
        name: mariadb
        enabled: yes
        state: started
      when: inventory_hostname == "maria1"

    # 6️⃣ Update Maria1 with full cluster config
    - name: Copy Maria1 full galera.cnf
      template:
        src: ../templates/galera_maria1_full.cnf.j2
        dest: /etc/my.cnf.d/galera.cnf
        owner: root
        group: root
        mode: '0644'
      when: inventory_hostname == "maria1"

    # 7️⃣ Configure Maria2
    - name: Copy Maria2 galera.cnf
      template:
        src: ../templates/galera_maria2.cnf.j2
        dest: /etc/my.cnf.d/galera.cnf
        owner: root
        group: root
        mode: '0644'
      when: inventory_hostname == "maria2"

    # 8️⃣ Configure Maria3
    - name: Copy Maria3 galera.cnf
      template:
        src: ../templates/galera_maria3.cnf.j2
        dest: /etc/my.cnf.d/galera.cnf
        owner: root
        group: root
        mode: '0644'
      when: inventory_hostname == "maria3"

    # 9️⃣ Enable and start Maria2 and Maria3
    - name: Enable and start Maria2 and Maria3
      systemd:
        name: mariadb
        enabled: yes
        state: started
      when: inventory_hostname != "maria1"

  handlers:
    - name: reload firewalld
      service:
        name: firewalld
        state: reloaded
