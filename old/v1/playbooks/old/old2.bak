- name: Install and configure MariaDB Galera Cluster
  hosts: mariadb
  become: yes
  gather_facts: yes
  vars_files:
    - ../group_vars/mariadb.yml

  tasks:

    # 0Ô∏è‚É£ Ensure Python MySQL library is installed
    - name: Install python3-PyMySQL on all nodes
      dnf:
        name: python3-PyMySQL
        state: present

    # 1Ô∏è‚É£ Install MariaDB Galera on all nodes
    - name: Install MariaDB Galera server
      dnf:
        name: mariadb-server-galera
        state: present

    # 2Ô∏è‚É£ Open firewall ports for MySQL and Galera replication
    - name: Open MariaDB and Galera ports in firewall
      firewalld:
        port: "{{ item }}"
        permanent: yes
        state: enabled
      loop:
        - 3306/tcp
        - 4567/tcp
        - 4568/tcp
        - 4444/tcp
      notify: reload firewalld

    # 3Ô∏è‚É£ Configure galera.cnf for bootstrap on maria1
    - name: Configure galera.cnf for bootstrap on maria1
      template:
        src: ../templates/galera_primary.cnf.j2
        dest: /etc/my.cnf.d/galera.cnf
      when: inventory_hostname == "maria1"

    # 4Ô∏è‚É£ Bootstrap MariaDB cluster on maria1
    - name: Bootstrap MariaDB cluster on maria1
      command: galera_new_cluster
      when: inventory_hostname == "maria1"

    # 5Ô∏è‚É£ Enable and start mariadb service on all nodes
    - name: Enable and start mariadb service
      systemd:
        name: mariadb
        enabled: yes
        state: started

    # 6Ô∏è‚É£ Wait for MariaDB socket to be ready
    - name: Wait for MariaDB socket to be available
      wait_for:
        path: /var/lib/mysql/mysql.sock
        state: present
        timeout: 60

    # 7Ô∏è‚É£ Update galera.cnf on maria1 with full cluster info
    - name: Update galera.cnf on maria1 with full cluster config
      template:
        src: ../templates/galera_primary_final.cnf.j2
        dest: /etc/my.cnf.d/galera.cnf
      when: inventory_hostname == "maria1"

    # 8Ô∏è‚É£ Configure galera.cnf for joining nodes (maria2, maria3)
    - name: Configure galera.cnf for joining nodes
      template:
        src: ../templates/galera_join.cnf.j2
        dest: /etc/my.cnf.d/galera.cnf
      when: inventory_hostname != "maria1"

    # 9Ô∏è‚É£ Wait for MariaDB TCP port to be open
    - name: Wait for MariaDB TCP port 3306
      wait_for:
        host: 127.0.0.1
        port: 3306
        state: started
        delay: 5
        timeout: 60

    # üîü Secure root account and set password on all nodes
    - name: Convert root to password authentication and secure account
      mysql_user:
        name: root
        host: "{{ item }}"
        password: "{{ mariadb_root_password }}"
        login_unix_socket: /var/run/mysqld/mysqld.sock
        priv: "*.*:ALL,GRANT"
        state: present
        check_implicit_admin: yes
      loop:
        - localhost
        - 127.0.0.1
        - '::1'

  handlers:
    - name: reload firewalld
      service:
        name: firewalld
        state: reloaded
