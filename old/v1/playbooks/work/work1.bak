- name: Install and configure MariaDB Galera cluster (common)
  hosts: mariadb
  become: yes
  gather_facts: yes
  vars_files:
    - ../group_vars/mariadb.yml

  tasks:

    # Install MariaDB Galera server
    - name: Install MariaDB Galera server
      dnf:
        name: mariadb-server-galera
        state: present

    # Open firewall ports
    - name: Open MariaDB and Galera ports in firewall
      firewalld:
        port: "{{ item }}"
        permanent: yes
        state: enabled
      loop:
        - 3306/tcp
        - 4567/tcp
        - 4568/tcp
        - 4444/tcp
      notify: reload firewalld

  handlers:
    - name: reload firewalld
      service:
        name: firewalld
        state: reloaded

- name: Configure and bootstrap Maria1
  hosts: maria1
  become: yes
  gather_facts: no
  vars_files:
    - ../group_vars/mariadb.yml

  tasks:

    # Copy Maria1 bootstrap galera.cnf
    - name: Copy Maria1 bootstrap galera.cnf
      template:
        src: ../templates/galera_maria1_bootstrap.cnf.j2
        dest: /etc/my.cnf.d/galera.cnf
        owner: root
        group: root
        mode: '0644'

    # Bootstrap Maria1
    - name: Bootstrap MariaDB cluster
      command: galera_new_cluster

    # Enable MariaDB service
    - name: Enable and start MariaDB
      systemd:
        name: mariadb
        enabled: yes
        state: started

    # Replace with full cluster config
    - name: Replace Maria1 galera.cnf with full config
      template:
        src: ../templates/galera_maria1_full.cnf.j2
        dest: /etc/my.cnf.d/galera.cnf
        owner: root
        group: root
        mode: '0644'

    # Secure MariaDB installation
    - name: Run mysql_secure_installation automatically
      expect:
        command: mysql_secure_installation
        responses:
          "Enter current password for root.*": ""
          "Switch to unix_socket authentication.*": "n"
          "Change the root password.*": "n"
          "Remove anonymous users.*": "y"
          "Disallow root login remotely.*": "y"
          "Remove test database and access to it.*": "y"
          "Reload privilege tables now.*": "y"

    # Set Maria1 root password
    - name: Set Maria1 root password
      shell: |
        mysql -u root <<EOF
        ALTER USER 'root'@'localhost' IDENTIFIED BY '{{ mariadb_root_password }}';
        FLUSH PRIVILEGES;
        EOF

- name: Configure and start MariaDB on Maria2 and Maria3
  hosts:
    - maria2
    - maria3
  become: yes
  gather_facts: no
  vars_files:
    - ../group_vars/mariadb.yml

  tasks:

    # Copy shared Galera config for Maria2 and Maria3
    - name: Copy Galera config for replicas
      template:
        src: ../templates/galera_replica.cnf.j2
        dest: /etc/my.cnf.d/galera.cnf
        owner: root
        group: root
        mode: '0644'

    # Enable and start MariaDB service
    - name: Enable and start MariaDB replicas
      systemd:
        name: mariadb
        enabled: yes
        state: started
